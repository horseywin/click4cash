<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="s2pF5uwW7vjbQJIBeFpBJlhuFCZrkTxMiVEgoSGQlZA" />
    <meta name="description" content="Click4Cash: Click to enter a weekly lucky draw and win 100% of the ad revenue!">
    <meta name="keywords" content="Click4Cash, click game, win cash, free contest, ad revenue">
    <meta name="author" content="horseywin">
    <meta property="og:title" content="Click4Cash">
    <meta property="og:description" content="Click to win 100% of weekly ad revenue in this fun, free contest!">
    <meta property="og:url" content="https://horseywin.github.io/click4cash/">
    <meta property="og:type" content="website">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M2 2l14 14-4 4-6-6-4-4z' fill='%23000'/><path d='M2 2l14 14-4 4-6-6-4-4z' stroke='%23fff' stroke-width='2' fill='none'/></svg>" type="image/svg+xml">
    <title>Click4Cash</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-check.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6598513151197899" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            cursor: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M2 2l14 14-4 4-6-6-4-4z" fill="%23000"/><path d="M2 2l14 14-4 4-6-6-4-4z" stroke="%23fff" stroke-width="2" fill="none"/></svg>') 2 2, auto;
        }
        body {
            background: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            gap: 30px;
            position: relative;
            overflow-y: scroll;
        }
        #top-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }
        button {
            background: #222;
            color: #fff;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            transition: 0.4s ease;
            font-size: 18px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        button:hover {
            background: #444;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }
        h1 {
            font-size: 48px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
        }
        #click-btn {
            background: linear-gradient(45deg, #0084ff, #ff1a75);
            font-size: 30px;
            padding: 50px 100px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            transform: scale(1);
            transition: transform 0.3s, background 0.4s ease;
            position: relative;
            z-index: 2;
        }
        #click-btn:hover {
            transform: scale(1.1);
            background: linear-gradient(45deg, #00d4ff, #ff69b3);
        }
        #click-btn:active {
            transform: scale(1);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }
        .container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 60px;
        }
        .card {
            background: rgba(50, 50, 50, 0.8);
            padding: 20px;
            border-radius: 12px;
            width: 300px;
            text-align: center;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            transform: translateY(-30px);
            opacity: 0;
            animation: slideUp 0.5s ease-in-out forwards;
        }
        .card h3 {
            font-size: 22px;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        .card p {
            font-size: 16px;
            margin-bottom: 10px;
            color: #ccc;
        }
        #profile-picture, #popup-profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: block;
        }
        .leaderboard-item {
            padding: 15px;
            border-radius: 8px;
            background: #444;
            margin-bottom: 15px;
            text-align: left;
            font-size: 16px;
            transition: background 0.3s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .leaderboard-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            display: inline-block;
        }
        .leaderboard-item span {
            display: inline-block;
        }
        .leaderboard-item:hover {
            background: #666;
        }
        @keyframes slideUp {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .space-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            opacity: 0.6;
            animation: moveStars 20s linear infinite;
        }
        @keyframes moveStars {
            0% { transform: translateY(-100vh); }
            100% { transform: translateY(100vh); }
        }
        .particle {
            position: absolute;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0));
            border-radius: 50%;
            pointer-events: none;
            animation: particleFade 1s ease-out forwards;
            z-index: 1;
        }
        @keyframes particleFade {
            0% { opacity: 1; transform: scale(0.1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        #login-popup, #signup-popup, #welcome-popup, #leaderboard-popup, #rules-popup, #error-popup, #user-profile-popup, #edit-profile-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #333;
            padding: 30px;
            border-radius: 15px;
            z-index: 10;
            color: #fff;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px;
        }
        #edit-profile-popup {
            text-align: left;
        }
        #login-popup h2, #signup-popup h2, #welcome-popup h2, #leaderboard-popup h2, #rules-popup h2, #error-popup h2, #user-profile-popup h2, #edit-profile-popup h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }
        #login-popup input, #signup-popup input, #edit-profile-popup textarea, #edit-profile-popup select, #edit-profile-popup input[type="file"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #555;
            border-radius: 8px;
            background: #444;
            color: #fff;
            font-size: 16px;
        }
        #edit-profile-popup label {
            display: block;
            margin-top: 10px;
        }
        #login-popup button, #signup-popup button, #welcome-popup button, #leaderboard-popup button, #rules-popup button, #error-popup button, #user-profile-popup button, #edit-profile-popup button {
            background: #0084ff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background 0.3s ease, transform 0.3s, box-shadow 0.3s;
        }
        #login-popup button:hover, #signup-popup button:hover, #welcome-popup button:hover, #leaderboard-popup button:hover, #rules-popup button:hover, #error-popup button:hover, #user-profile-popup button:hover, #edit-profile-popup button:hover {
            background: #00d4ff;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }
        #login-popup button[type="submit"], #signup-popup button[type="submit"], #edit-profile-popup button[type="submit"] {
            background: #ff1a75;
        }
        #login-popup button[type="submit"]:hover, #signup-popup button[type="submit"]:hover, #edit-profile-popup button[type="submit"]:hover {
            background: #ff69b3;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }
        #welcome-popup p, #rules-popup p, #error-popup p, #user-profile-popup p {
            margin-bottom: 20px;
            font-size: 18px;
            color: #ccc;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 5;
            display: none;
        }
        #edit-profile-btn {
            display: block;
            margin: 0 auto; /* Center the button */
            padding: 10px 20px; /* Match login button size */
        }
    </style>
</head>
<body>
    <div id="top-bar">
        <button id="login-btn" onclick="showLogin()">Login</button>
        <button id="signup-btn" onclick="showSignUp()">Sign Up</button>
        <button onclick="logout()" id="logout-btn" style="display: none;">Logout</button>
    </div>

    <h1>Click4Cash</h1>
    <button id="click-btn" onclick="incrementClicks()">Click Me!</button>
    <p id="click-message" style="color: red; display: none;">Please sign in to start clicking!</p>

    <div class="container">
        <div class="card">
            <h3>About</h3>
            <p>Click4Cash is a fun, free game where every click enters you into a weekly lucky draw to win 100% of the ad revenue!</p>
        </div>
        <div class="card">
            <h3>Leaderboard</h3>
            <div id="leaderboard"></div>
            <button onclick="showLeaderboardPopup()">See All</button>
        </div>
        <div class="card">
            <h3>Your Profile</h3>
            <img id="profile-picture" src="" alt="Profile Picture" style="display: none;">
            <p id="user-email">Not Logged In</p>
            <p id="join-date"></p>
            <p id="bio">No bio yet</p>
            <p id="country">Not specified</p>
            <p id="click-count">Clicks: 0</p>
            <p id="chance-of-winning">Chance of Winning: 0%</p>
            <button id="edit-profile-btn" onclick="showEditProfilePopup()" style="display: none;">Edit Profile</button>
        </div>
    </div>

    <div id="welcome-popup">
        <h2>Welcome to Click4Cash!</h2>
        <p id="welcome-message"></p>
        <button onclick="closeWelcomePopup()">Got It!</button>
    </div>

    <div id="rules-popup">
        <h2>How Click4Cash Works</h2>
        <p>Click the button as many times as you can to increase your chances of winning. Each click is an entry into the weekly lucky draw. The more you click, the higher your chance of winning! The winner receives 100% of the weekly ad revenue.</p>
        <button onclick="closeRulesPopup()">Got It!</button>
    </div>

    <div id="leaderboard-popup">
        <h2>Full Leaderboard</h2>
        <div id="full-leaderboard"></div>
        <button onclick="hideLeaderboardPopup()">Close</button>
    </div>

    <div id="overlay"></div>
    <div id="login-popup">
        <h2>Sign In</h2>
        <form onsubmit="login(event)">
            <input type="email" id="email" placeholder="Email" required><br>
            <input type="password" id="password" placeholder="Password" required><br>
            <button type="submit">Login</button>
        </form>
        <button onclick="hideLogin()">Cancel</button>
    </div>

    <div id="signup-popup">
        <h2>Sign Up</h2>
        <form onsubmit="signUp(event)">
            <input type="text" id="signup-username" placeholder="Username (max 12 chars)" maxlength="12" required><br>
            <input type="email" id="signup-email" placeholder="Email" required><br>
            <input type="password" id="signup-password" placeholder="Password" required><br>
            <p><small>By signing up, you agree to receive an email confirmation if you win!</small></p>
            <button type="submit">Sign Up</button>
        </form>
        <button onclick="hideSignUp()">Cancel</button>
    </div>

    <div id="error-popup">
        <h2>Oops!</h2>
        <p id="error-message">Something went wrong. Please try again.</p>
        <button onclick="hideErrorPopup()">Okay</button>
    </div>

    <div id="user-profile-popup">
        <h2>User Profile</h2>
        <img id="popup-profile-picture" src="" alt="Profile Picture">
        <p id="popup-user-email"></p>
        <p id="popup-bio"></p>
        <p id="popup-country"></p>
        <p id="popup-join-date"></p>
        <p id="popup-clicks"></p>
        <button onclick="hideUserProfilePopup()">Close</button>
    </div>

    <div id="edit-profile-popup">
        <h2>Edit Profile</h2>
        <form onsubmit="saveProfile(event)">
            <label for="bio-input">Bio:</label>
            <textarea id="bio-input" rows="3"></textarea>
            <label for="country-input">Country:</label>
            <select id="country-input">
                <option value="">Select Country</option>
                <option value="USA">USA</option>
                <option value="Canada">Canada</option>
                <option value="UK">UK</option>
                <option value="Australia">Australia</option>
            </select>
            <label for="profile-picture-input">Profile Picture:</label>
            <input type="file" id="profile-picture-input" accept="image/*">
            <button type="submit">Save</button>
        </form>
        <button onclick="hideEditProfilePopup()">Cancel</button>
    </div>

    <div class="space-background" id="space-background"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCQeZ1EOPbHOy8_wOBBvlchZwj8tTCZM2w",
            authDomain: "click4cash-7e106.firebaseapp.com",
            projectId: "click4cash-7e106",
            storageBucket: "click4cash-7e106.appspot.com",
            messagingSenderId: "689145020485",
            appId: "1:689145020485:web:458d083ec5bca7d8b3e32c"
        };
        firebase.initializeApp(firebaseConfig);
        const appCheck = firebase.appCheck();
        appCheck.activate('6LdQq-4qAAAAABzNzVlhJzLlxbK3zh6M5NiHY7cf', true);
        appCheck.getToken().then(token => console.log("App Check Token:", token)).catch(err => console.error("App Check Error:", err));
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null;
        let totalClicks = 0;
        let localClicks = 0;
        let clickBuffer = 0;
        let syncTimeout = null;
        let baseStarSpeed = 20;
        let clickSpeedBoost = false;
        const defaultProfilePic = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="%23ccc"/><path d="M12 12c2.67 0 4 1.33 4 4H8c0-2.67 1.33-4 4-4z" fill="%23fff"/></svg>';

        if (!localStorage.getItem('visited')) {
            showRulesPopup();
            localStorage.setItem('visited', 'true');
        }

        function initSpaceBackground() {
            const spaceBackground = document.getElementById('space-background');
            const starCount = 100;
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = `${Math.random() * 3 + 1}px`;
                star.style.height = star.style.width;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * -100}vh`;
                star.style.animationDuration = `${baseStarSpeed + Math.random() * 10}s`;
                spaceBackground.appendChild(star);
            }
        }

        function updateStarSpeed(faster = false) {
            const stars = document.querySelectorAll('.star');
            const newSpeed = faster ? baseStarSpeed / 2 : baseStarSpeed;
            stars.forEach(star => {
                star.style.animationDuration = `${newSpeed + Math.random() * 5}s`;
            });
        }

        function createParticles(x, y) {
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                const size = Math.random() * 20 + 10;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${x - size / 2}px`;
                particle.style.top = `${y - size / 2}px`;
                const angle = Math.random() * 2 * Math.PI;
                const velocity = Math.random() * 100 + 50;
                particle.style.transform = `translate(${Math.cos(angle) * velocity}px, ${Math.sin(angle) * velocity}px)`;
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1000);
            }
        }

        function updateLeaderboard() {
            db.collection("users").orderBy("clicks", "desc").limit(5).get()
                .then((snapshot) => {
                    let leaderboardHTML = '';
                    totalClicks = 0;
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.clicks !== undefined) {
                            leaderboardHTML += `<div class="leaderboard-item" data-user-id="${doc.id}" onclick="showUserProfile('${doc.id}')">
                                <img src="${userData.profilePictureUrl || defaultProfilePic}" alt="Profile">
                                <span>${userData.username} - ${userData.clicks} clicks</span>
                            </div>`;
                            totalClicks += userData.clicks;
                        }
                    });
                    document.getElementById('leaderboard').innerHTML = leaderboardHTML;
                    updateChanceOfWinning();
                })
                .catch(err => console.error("Error fetching leaderboard: ", err));
        }

        function showLeaderboardPopup() {
            db.collection("users").orderBy("clicks", "desc").get()
                .then((snapshot) => {
                    let leaderboardHTML = '';
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.clicks !== undefined) {
                            leaderboardHTML += `<div class="leaderboard-item" data-user-id="${doc.id}" onclick="showUserProfile('${doc.id}')">
                                <img src="${userData.profilePictureUrl || defaultProfilePic}" alt="Profile">
                                <span>${userData.username} - ${userData.clicks} clicks</span>
                            </div>`;
                        }
                    });
                    document.getElementById('full-leaderboard').innerHTML = leaderboardHTML;
                    document.getElementById('leaderboard-popup').style.display = 'block';
                    document.getElementById('overlay').style.display = 'block';
                })
                .catch(err => console.error("Error fetching leaderboard: ", err));
        }

        function hideLeaderboardPopup() {
            document.getElementById('leaderboard-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function updateChanceOfWinning() {
            if (currentUser) {
                const userRef = db.collection("users").doc(currentUser.uid);
                userRef.get().then((doc) => {
                    if (doc.exists) {
                        const userClicks = doc.data().clicks || 0;
                        const chance = totalClicks > 0 ? ((userClicks / totalClicks) * 100).toFixed(2) : 0;
                        document.getElementById('chance-of-winning').innerText = `Chance of Winning: ${chance}%`;
                    }
                });
            }
        }

        function showRulesPopup() {
            document.getElementById('rules-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeRulesPopup() {
            document.getElementById('rules-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function showLogin() {
            document.getElementById('login-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function hideLogin() {
            document.getElementById('login-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function showSignUp() {
            document.getElementById('signup-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function hideSignUp() {
            document.getElementById('signup-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function showWelcomePopup(username) {
            document.getElementById('welcome-message').innerText = `Welcome, ${username}! You could win 100% of the weekly ad revenue!`;
            document.getElementById('welcome-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeWelcomePopup() {
            document.getElementById('welcome-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function showErrorPopup(message) {
            document.getElementById('error-message').innerText = message;
            document.getElementById('error-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function hideErrorPopup() {
            document.getElementById('error-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function showUserProfile(userId) {
            const userRef = db.collection("users").doc(userId);
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('popup-profile-picture').src = data.profilePictureUrl || defaultProfilePic;
                    document.getElementById('popup-user-email').innerText = `Username: ${data.username}\nEmail: ${data.email}`;
                    document.getElementById('popup-bio').innerText = data.bio || "No bio yet";
                    document.getElementById('popup-country').innerText = data.country || "Not specified";
                    document.getElementById('popup-join-date').innerText = `Joined: ${new Date(data.joinDate).toLocaleDateString()}`;
                    document.getElementById('popup-clicks').innerText = `Clicks: ${data.clicks || 0}`;
                    document.getElementById('user-profile-popup').style.display = 'block';
                    document.getElementById('overlay').style.display = 'block';
                }
            }).catch((error) => console.error("Error fetching user profile: ", error));
        }

        function hideUserProfilePopup() {
            document.getElementById('user-profile-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function showEditProfilePopup() {
            if (currentUser) {
                const userRef = db.collection("users").doc(currentUser.uid);
                userRef.get().then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('bio-input').value = data.bio || "";
                        document.getElementById('country-input').value = data.country || "";
                        document.getElementById('profile-picture-input').value = "";
                        document.getElementById('edit-profile-popup').style.display = 'block';
                        document.getElementById('overlay').style.display = 'block';
                    }
                }).catch((error) => console.error("Error loading profile data: ", error));
            }
        }

        function hideEditProfilePopup() {
            document.getElementById('edit-profile-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function login(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            console.log("Login attempt:", { email, password });

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    loadUserData();
                    setTimeout(updateLeaderboard, 1000);
                    document.getElementById('click-message').style.display = 'none';
                    document.getElementById('login-btn').style.display = 'none';
                    document.getElementById('signup-btn').style.display = 'none';
                    document.getElementById('logout-btn').style.display = 'inline-block';
                    document.getElementById('click-btn').disabled = false;
                    hideLogin();
                    document.getElementById('user-email').innerText = currentUser.email;
                })
                .catch((error) => {
                    console.error("Login error:", error);
                    let friendlyMessage = "Login failed. Please try again.";
                    if (error.code === 'auth/user-not-found') {
                        friendlyMessage = "No account found with this email. Please sign up!";
                    } else if (error.code === 'auth/wrong-password' || error.message.includes("INVALID_LOGIN_CREDENTIALS")) {
                        friendlyMessage = "Incorrect password. Please check and try again.";
                    }
                    showErrorPopup(friendlyMessage);
                });
        }

        function signUp(event) {
            event.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            if (username.length === 0) {
                showErrorPopup("Please enter a username!");
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    const userRef = db.collection("users").doc(currentUser.uid);
                    userRef.set({
                        username: username,
                        email: currentUser.email,
                        clicks: 0,
                        joinDate: new Date().toISOString(),
                        playtime: 0,
                        bio: "",
                        profilePictureUrl: "",
                        country: ""
                    }).then(() => {
                        updateLeaderboard();
                        hideSignUp();
                        showWelcomePopup(username);
                    }).catch((error) => console.error("Error creating user document: ", error));
                })
                .catch((error) => {
                    let friendlyMessage = "Sign-up failed. Please try again.";
                    if (error.code === 'auth/email-already-in-use') {
                        friendlyMessage = "This email is already in use. Try logging in!";
                    } else if (error.code === 'auth/weak-password') {
                        friendlyMessage = "Password too weak. Use at least 6 characters.";
                    }
                    showErrorPopup(friendlyMessage);
                });
        }

        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                localClicks = 0;
                clickBuffer = 0;
                document.getElementById('click-count').innerText = 'Clicks: 0';
                document.getElementById('user-email').innerText = 'Not Logged In';
                document.getElementById('bio').innerText = 'No bio yet';
                document.getElementById('country').innerText = 'Not specified';
                document.getElementById('join-date').innerText = '';
                document.getElementById('profile-picture').style.display = 'none';
                document.getElementById('chance-of-winning').innerText = 'Chance of Winning: 0%';
                document.getElementById('login-btn').style.display = 'inline-block';
                document.getElementById('signup-btn').style.display = 'inline-block';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('edit-profile-btn').style.display = 'none';
                document.getElementById('click-message').style.display = 'block';
                document.getElementById('click-btn').disabled = true;
            }).catch((error) => console.error("Logout failed: ", error));
        }

        function loadUserData() {
            if (currentUser) {
                const userRef = db.collection("users").doc(currentUser.uid);
                userRef.get().then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        localClicks = data.clicks || 0;
                        document.getElementById('click-count').innerText = `Clicks: ${localClicks}`;
                        document.getElementById('join-date').innerText = `Joined: ${new Date(data.joinDate).toLocaleDateString()}`;
                        document.getElementById('bio').innerText = data.bio || "No bio yet";
                        document.getElementById('country').innerText = data.country || "Not specified";
                        if (data.profilePictureUrl) {
                            document.getElementById('profile-picture').src = data.profilePictureUrl;
                            document.getElementById('profile-picture').style.display = 'block';
                        } else {
                            document.getElementById('profile-picture').style.display = 'none';
                        }
                        document.getElementById('edit-profile-btn').style.display = 'block';
                    }
                }).catch((error) => console.error("Error loading user data: ", error));
            }
        }

        function saveProfile(event) {
            event.preventDefault();
            if (!currentUser) return;

            const bio = document.getElementById('bio-input').value;
            const country = document.getElementById('country-input').value;
            const file = document.getElementById('profile-picture-input').files[0];
            const userRef = db.collection("users").doc(currentUser.uid);

            if (file) {
                if (file.size > 32 * 1024 * 1024) {
                    showErrorPopup("Image must be under 32 MB!");
                    return;
                }
                const formData = new FormData();
                formData.append("image", file);
                fetch("https://api.imgbb.com/1/upload?key=6055d35ebda650b6bc19fbdffc564e0d", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    console.log("ImgBB Response:", data);
                    if (data.success) {
                        const url = data.data.url;
                        return userRef.update({ bio, country, profilePictureUrl: url })
                            .then(() => {
                                console.log("Firestore updated with:", { bio, country, profilePictureUrl: url });
                                loadUserData();
                                hideEditProfilePopup();
                            });
                    } else {
                        showErrorPopup("Image upload failed: " + (data.error?.message || "Unknown error"));
                    }
                })
                .catch(err => {
                    console.error("ImgBB/Firestore error:", err);
                    showErrorPopup("Profile update failed!");
                });
            } else {
                userRef.update({ bio, country })
                    .then(() => {
                        console.log("Firestore updated with:", { bio, country });
                        loadUserData();
                        hideEditProfilePopup();
                    })
                    .catch(err => console.error("Firestore update error:", err));
            }
        }

        function syncClicks() {
            if (clickBuffer > 0 && currentUser) {
                const userRef = db.collection("users").doc(currentUser.uid);
                userRef.update({
                    clicks: firebase.firestore.FieldValue.increment(clickBuffer)
                }).then(() => {
                    clickBuffer = 0;
                    updateLeaderboard();
                }).catch(err => console.error("Error syncing clicks: ", err));
            }
        }

        function incrementClicks(event) {
            if (!currentUser) {
                document.getElementById('click-message').style.display = 'block';
                return;
            }

            document.getElementById('click-message').style.display = 'none';
            localClicks += 1;
            clickBuffer += 1;
            document.getElementById('click-count').innerText = `Clicks: ${localClicks}`;

            const rect = document.getElementById('click-btn').getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            createParticles(x, y);

            if (!clickSpeedBoost) {
                clickSpeedBoost = true;
                updateStarSpeed(true);
                setTimeout(() => {
                    clickSpeedBoost = false;
                    updateStarSpeed(false);
                }, 2000);
            }

            if (syncTimeout) clearTimeout(syncTimeout);
            syncTimeout = setTimeout(syncClicks, 500);
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserData();
                setTimeout(updateLeaderboard, 1000);
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('signup-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'inline-block';
                document.getElementById('click-btn').disabled = false;
                document.getElementById('user-email').innerText = currentUser.email;
            } else {
                currentUser = null;
                localClicks = 0;
                clickBuffer = 0;
                document.getElementById('click-count').innerText = 'Clicks: 0';
                document.getElementById('user-email').innerText = 'Not Logged In';
                document.getElementById('bio').innerText = 'No bio yet';
                document.getElementById('country').innerText = 'Not specified';
                document.getElementById('join-date').innerText = '';
                document.getElementById('profile-picture').style.display = 'none';
                document.getElementById('login-btn').style.display = 'inline-block';
                document.getElementById('signup-btn').style.display = 'inline-block';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('click-btn').disabled = true;
                document.getElementById('edit-profile-btn').style.display = 'none';
            }
        });

        initSpaceBackground();
    </script>
</body>
</html>