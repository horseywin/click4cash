// Initialize Firebase
const firebaseConfig = {
    apiKey: "AIzaSyCQeZ1EOPbHOy8_wOBBvlchZwj8tTCZM2w",
    authDomain: "click4cash-7e106.firebaseapp.com",
    projectId: "click4cash-7e106",
    storageBucket: "click4cash-7e106.appspot.com",
    messagingSenderId: "689145020485",
    appId: "1:689145020485:web:458d083ec5bca7d8b3e32c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

// Fetch leaderboard data and update
function updateLeaderboard() {
    db.collection("users").orderBy("clicks", "desc").get()
        .then((snapshot) => {
            let leaderboardHTML = '';
            snapshot.forEach(doc => {
                const userData = doc.data();
                if (userData.clicks !== undefined) {
                    leaderboardHTML += `<div class="leaderboard-item">${userData.email} - ${userData.clicks} clicks</div>`;
                }
            });
            document.getElementById('leaderboard').innerHTML = leaderboardHTML;
        })
        .catch(err => {
            console.error("Error fetching leaderboard: ", err);
        });
}

// Login Function
function login(event) {
    event.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            currentUser = userCredential.user;
            updateLeaderboard();
            document.getElementById('click-message').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'inline-block';
            document.getElementById('click-btn').disabled = false; // Enable the click button
            hideLogin();
            document.getElementById('user-email').innerText = currentUser.email;

            // Initialize click count for the user
            initializeUserClicks();
        })
        .catch((error) => {
            alert("Login failed: " + error.message);
        });
}

// Initialize user clicks in Firestore
function initializeUserClicks() {
    const userRef = db.collection("users").doc(currentUser.uid);
    userRef.get().then((doc) => {
        if (!doc.exists) {
            // If the user doesn't exist in Firestore, create a new document
            userRef.set({
                email: currentUser.email,
                clicks: 0
            }).then(() => {
                document.getElementById('click-count').innerText = 0;
            });
        } else {
            // If the user exists, update the click count display
            document.getElementById('click-count').innerText = doc.data().clicks || 0;
        }
    }).catch((error) => {
        console.error("Error initializing user clicks: ", error);
    });
}

// Increment Clicks
function incrementClicks() {
    if (currentUser) {
        const userRef = db.collection("users").doc(currentUser.uid);
        userRef.update({
            clicks: firebase.firestore.FieldValue.increment(1)
        }).then(() => {
            // Update the click count display
            userRef.get().then((doc) => {
                if (doc.exists) {
                    document.getElementById('click-count').innerText = doc.data().clicks;
                }
            });
            updateLeaderboard();
        }).catch(err => {
            console.error("Error updating clicks: ", err);
        });
    } else {
        alert("Please sign in to start clicking!");
    }
}

// Sign Up Function
function signUp(event) {
    event.preventDefault();
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;

    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            currentUser = userCredential.user;
            updateLeaderboard();
            hideSignUp();
            showWelcomePopup();

            // Initialize click count for the new user
            initializeUserClicks();
        })
        .catch((error) => {
            alert("Sign Up failed: " + error.message);
        });
}