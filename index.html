<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="s2pF5uwW7vjbQJIBeFpBJlhuFCZrkTxMiVEgoSGQlZA" />
    <meta name="description" content="Click4Cash: Click to enter a weekly lucky draw and win 100% of the ad revenue!">
    <meta name="keywords" content="Click4Cash, click game, win cash, free contest, ad revenue">
    <meta name="author" content="horseywin">
    <meta property="og:title" content="Click4Cash">
    <meta property="og:description" content="Click to win 100% of weekly ad revenue in this fun, free contest!">
    <meta property="og:url" content="https://horseywin.github.io/click4cash/">
    <meta property="og:type" content="website">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M2 2l14 14-4 4-6-6-4-4z' fill='%23000'/><path d='M2 2l14 14-4 4-6-6-4-4z' stroke='%23fff' stroke-width='2' fill='none'/></svg>" type="image/svg+xml">
    <title>Click4Cash</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-check.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6598513151197899" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@400;700&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Oxanium', sans-serif;
            font-weight: 700;
            cursor: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M2 2l14 14-4 4-6-6-4-4z" fill="%23000"/><path d="M2 2l14 14-4 4-6-6-4-4z" stroke="%23fff" stroke-width="2" fill="none"/></svg>') 2 2, auto;
        }
        body {
            background: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            gap: 30px;
            position: relative;
            overflow-y: scroll;
        }
        #top-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }
        button {
            background: #222;
            color: #fff;
            border: 1px solid #999999;
            padding: 15px 25px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 18px;
            border-radius: 8px;
            text-transform: uppercase;
        }
        button:hover {
            background: #333;
        }
        h1 {
            font-size: 48px;
            text-shadow: 0 0 3px #999999;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        #click-btn {
            background: #222;
            font-size: 30px;
            padding: 50px 100px;
            border: 2px solid #999999;
            border-radius: 50px;
            transition: transform 0.3s;
        }
        #click-btn:hover {
            transform: scale(1.05);
        }
        #click-btn:active {
            transform: scale(1);
        }
        .container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 60px;
        }
        .card {
            background: #111;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10"><path d="M0 10L10 0M2 10L12 0M4 10L14 0" stroke="%23999999" stroke-width="0.5" opacity="0.3"/></svg>');
            background-size: 10px 10px;
            padding: 20px;
            border-radius: 12px;
            width: 300px;
            text-align: center;
            border: 1px solid #999999;
            animation: slideUp 0.5s ease-in-out forwards;
        }
        .card h3 {
            font-size: 22px;
            margin-bottom: 15px;
            text-shadow: 0 0 2px #999999;
            text-transform: uppercase;
        }
        .card p {
            font-size: 16px;
            margin-bottom: 10px;
            color: #bbb;
        }
        #profile-picture, #popup-profile-picture {
            display: block;
            margin: 0 auto;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 1px solid #999999;
        }
        .leaderboard-item {
            padding: 15px;
            border-radius: 8px;
            background: #111;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10"><path d="M0 10L10 0M2 10L12 0M4 10L14 0" stroke="%23999999" stroke-width="0.5" opacity="0.3"/></svg>');
            background-size: 10px 10px;
            margin-bottom: 15px;
            text-align: left;
            font-size: 16px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            cursor: pointer;
            border: 1px solid #999999;
        }
        .leaderboard-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #999999;
        }
        .leaderboard-item:hover {
            background: #222;
        }
        .leaderboard-item .click-increment {
            color: #00ff00;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .leaderboard-item .click-increment.show {
            opacity: 1;
        }
        @keyframes slideUp {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .space-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            opacity: 0.5;
            animation: moveStars linear infinite;
            will-change: transform;
        }
        @keyframes moveStars {
            0% { transform: translateY(-100vh); }
            100% { transform: translateY(100vh); }
        }
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            animation: particleMove 0.5s ease-out forwards;
            z-index: 1;
        }
        @keyframes particleMove {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.5); }
        }
        #login-popup, #signup-popup, #welcome-popup, #leaderboard-popup, #rules-popup, #error-popup, #user-profile-popup, #edit-profile-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #111;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10"><path d="M0 10L10 0M2 10L12 0M4 10L14 0" stroke="%23999999" stroke-width="0.5" opacity="0.3"/></svg>');
            background-size: 10px 10px;
            padding: 30px;
            border-radius: 15px;
            z-index: 10;
            color: #fff;
            text-align: center;
            border: 1px solid #999999;
            width: 90%;
            max-width: 400px;
        }
        #edit-profile-popup { text-align: left; }
        #login-popup h2, #signup-popup h2, #welcome-popup h2, #leaderboard-popup h2, #rules-popup h2, #error-popup h2, #user-profile-popup h2, #edit-profile-popup h2 {
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 0 0 2px #999999;
            text-transform: uppercase;
        }
        #login-popup input, #signup-popup input, #edit-profile-popup textarea, #edit-profile-popup select, #edit-profile-popup input[type="file"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #999999;
            border-radius: 8px;
            background: #222;
            color: #fff;
            font-size: 16px;
        }
        #edit-profile-popup label {
            display: block;
            margin-top: 10px;
            color: #fff;
        }
        #login-popup button, #signup-popup button, #welcome-popup button, #leaderboard-popup button, #rules-popup button, #error-popup button, #user-profile-popup button, #edit-profile-popup button {
            background: #222;
            color: #fff;
            border: 1px solid #999999;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background 0.3s;
        }
        #login-popup button:hover, #signup-popup button:hover, #welcome-popup button:hover, #leaderboard-popup button:hover, #rules-popup button:hover, #error-popup button:hover, #user-profile-popup button:hover, #edit-profile-popup button:hover {
            background: #333;
        }
        #login-popup button[type="submit"], #signup-popup button[type="submit"], #edit-profile-popup button[type="submit"] {
            background: #999999;
            color: #000;
        }
        #login-popup button[type="submit"]:hover, #signup-popup button[type="submit"]:hover, #edit-profile-popup button[type="submit"]:hover {
            background: #777777;
        }
        #welcome-popup p, #rules-popup p, #error-popup p, #user-profile-popup p {
            margin-bottom: 20px;
            font-size: 18px;
            color: #bbb;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 5;
            display: none;
        }
        #edit-profile-btn, #delete-account-btn {
            display: block;
            margin: 0 auto;
            padding: 10px 20px;
        }
        @media (max-width: 768px) {
            h1 { font-size: 36px; }
            #click-btn { padding: 30px 60px; font-size: 24px; }
            .container { flex-direction: column; align-items: center; }
            .card { width: 90%; }
        }
        @media (max-width: 480px) {
            h1 { font-size: 24px; }
            #click-btn { padding: 20px 40px; font-size: 18px; }
        }
    </style>
</head>
<body>
    <div id="top-bar">
        <button id="login-btn" onclick="showLogin()">Login</button>
        <button id="signup-btn" onclick="showSignUp()">Sign Up</button>
        <button onclick="logout()" id="logout-btn" style="display: none;">Logout</button>
    </div>

    <h1>Click4Cash</h1>
    <button id="click-btn" onclick="incrementClicks(event)">Click Me!</button>
    <p id="click-message" style="color: red; display: none;">Please sign in to start clicking!</p>

    <div class="container">
        <div class="card">
            <h3>Your Profile</h3>
            <img id="profile-picture" src="" alt="Profile Picture" style="display: none;">
            <p id="user-email">Not Logged In</p>
            <p id="join-date"></p>
            <p id="bio">No bio yet</p>
            <p id="country">Not specified</p>
            <p id="click-count">Clicks: 0</p>
            <p id="highest-cps">Highest CPS: 0</p>
            <p id="chance-of-winning">Chance of Winning: 0%</p>
            <button id="edit-profile-btn" onclick="showEditProfilePopup()" style="display: none;">Edit Profile</button>
            <button id="delete-account-btn" onclick="deleteAccount()" style="display: none;">Delete Account</button>
        </div>
        <div class="card">
            <h3>Leaderboard</h3>
            <div id="leaderboard-loading" style="display: none;">Loading...</div>
            <div id="leaderboard"></div>
            <button onclick="showLeaderboardPopup()">See All</button>
        </div>
        <div class="card">
            <h3>About</h3>
            <p>Click4Cash is an interstellar adventure where every click propels you into a cosmic contest! Join explorers across the galaxy, clicking to earn entries in our weekly lucky draw. The prize? 100% of the ad revenue, beamed directly to the winner’s orbit. No cost to play—just pure, gravity-defying fun!</p>
        </div>
    </div>

    <div id="welcome-popup">
        <h2>Welcome to Click4Cash!</h2>
        <p id="welcome-message"></p>
        <button onclick="closeWelcomePopup()">Got It!</button>
    </div>

    <div id="rules-popup">
        <h2>How Click4Cash Works</h2>
        <p>Click the button as many times as you can to increase your chances of winning. Each click is an entry into the weekly lucky draw. The more you click, the higher your chance of winning! The winner receives 100% of the weekly ad revenue.</p>
        <button onclick="closeRulesPopup()">Got It!</button>
    </div>

    <div id="leaderboard-popup">
        <h2>Full Leaderboard</h2>
        <div id="full-leaderboard"></div>
        <button onclick="hideLeaderboardPopup()">Close</button>
    </div>

    <div id="overlay"></div>
    <div id="login-popup">
        <h2>Sign In</h2>
        <form onsubmit="login(event)">
            <input type="email" id="email" placeholder="Email" required><br>
            <input type="password" id="password" placeholder="Password" required><br>
            <button type="submit">Login</button>
        </form>
        <button onclick="hideLogin()">Cancel</button>
    </div>

    <div id="signup-popup">
        <h2>Sign Up</h2>
        <form onsubmit="signUp(event)">
            <input type="text" id="signup-username" placeholder="Username (max 12 chars)" maxlength="12" required><br>
            <input type="email" id="signup-email" placeholder="Email" required><br>
            <input type="password" id="signup-password" placeholder="Password" required><br>
            <label for="privacy-toggle">Make email public?</label>
            <input type="checkbox" id="privacy-toggle" name="privacy-toggle"><br>
            <p><small>By signing up, you agree to receive an email confirmation if you win!</small></p>
            <button type="submit">Sign Up</button>
        </form>
        <button onclick="hideSignUp()">Cancel</button>
    </div>

    <div id="error-popup">
        <h2>Oops!</h2>
        <p id="error-message">Something went wrong. Please try again.</p>
        <button onclick="hideErrorPopup()">Okay</button>
    </div>

    <div id="user-profile-popup">
        <h2>User Profile</h2>
        <img id="popup-profile-picture" src="" alt="Profile Picture">
        <p id="popup-user-email"></p>
        <p id="popup-bio"></p>
        <p id="popup-country"></p>
        <p id="popup-join-date"></p>
        <p id="popup-clicks"></p>
        <p id="popup-highest-cps"></p>
        <button onclick="hideUserProfilePopup()">Close</button>
    </div>

    <div id="edit-profile-popup">
        <h2>Edit Profile</h2>
        <form onsubmit="saveProfile(event)">
            <label for="bio-input">Bio:</label>
            <textarea id="bio-input" rows="3"></textarea>
            <label for="country-input">Country:</label>
            <select id="country-input">
                <option value="">Select Country</option>
                <option value="USA">USA</option>
                <option value="Canada">Canada</option>
                <option value="UK">UK</option>
                <option value="Australia">Australia</option>
            </select>
            <label for="profile-picture-input">Profile Picture:</label>
            <input type="file" id="profile-picture-input" accept="image/*">
            <button type="submit">Save</button>
        </form>
        <button onclick="hideEditProfilePopup()">Cancel</button>
    </div>

    <div class="space-background" id="space-background"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCQeZ1EOPbHOy8_wOBBvlchZwj8tTCZM2w",
            authDomain: "click4cash-7e106.firebaseapp.com",
            projectId: "click4cash-7e106",
            storageBucket: "click4cash-7e106.appspot.com",
            messagingSenderId: "689145020485",
            appId: "1:689145020485:web:458d083ec5bca7d8b3e32c"
        };
        firebase.initializeApp(firebaseConfig);
        const appCheck = firebase.appCheck();
        appCheck.activate('6LdQq-4qAAAAABzNzVlhJzLlxbK3zh6M5NiHY7cf', true); // Replace with your reCAPTCHA Site 
        appCheck.getToken().then(token => console.log("App Check Token:", token)).catch(err => console.error("App Check Error:", err));
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
    
        let currentUser = null;
        let totalClicks = 0;
        let localClicks = 0;
        let clickBuffer = 0;
        let syncTimeout = null;
        let baseStarSpeed = 20;
        let clickSpeedBoost = false;
        let leaderboardListener = null;
        let profileListener = null;
        let clickTimestamps = [];
        let fakeCPSCount = 0;
        let highestCPS = 0;
        const defaultProfilePic = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"><path d="M2 2l14 14-4 4-6-6-4-4z" fill="%23000"/><path d="M2 2l14 14-4 4-6-6-4-4z" stroke="%23fff" stroke-width="2" fill="none"/></svg>';
    
        if (!localStorage.getItem('visited')) {
            showRulesPopup();
            localStorage.setItem('visited', 'true');
        }
    
        function initSpaceBackground() {
            const spaceBackground = document.getElementById('space-background');
            const starCount = 30;
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = `${Math.random() * 3 + 1}px`;
                star.style.height = star.style.width;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * -100}vh`;
                star.style.animationDuration = `${baseStarSpeed + Math.random() * 10}s`;
                spaceBackground.appendChild(star);
            }
        }
    
        function updateStarSpeed(faster = false) {
            const stars = document.querySelectorAll('.star');
            const newSpeed = faster ? baseStarSpeed / 4 : baseStarSpeed;
            stars.forEach(star => {
                star.style.animationDuration = `${newSpeed + Math.random() * 5}s`;
            });
        }
    
        function createParticles(x, y) {
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                const size = Math.random() * 3 + 1;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.background = `hsl(${Math.random() * 60 + 30}, 100%, 50%)`;
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                const angle = Math.random() * 2 * Math.PI;
                const velocity = Math.random() * 100 + 50;
                const dx = Math.cos(angle) * velocity;
                const dy = Math.sin(angle) * velocity;
                particle.style.setProperty('--dx', `${dx}px`);
                particle.style.setProperty('--dy', `${dy}px`);
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 500);
            }
        }
    
        function startProfileListener() {
            if (currentUser && currentUser.emailVerified) {
                profileListener = db.collection("users").doc(currentUser.uid).onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        localClicks = data.clicks || 0;
                        document.getElementById('click-count').innerText = `Clicks: ${localClicks}`;
                        document.getElementById('join-date').innerText = `Joined: ${new Date(data.joinDate).toLocaleDateString()}`;
                        document.getElementById('bio').innerText = data.bio || "No bio yet";
                        document.getElementById('country').innerText = data.country || "Not specified";
                        document.getElementById('highest-cps').innerText = `Highest CPS: ${data.highestCPS || 0}`;
                        if (data.profilePictureUrl) {
                            document.getElementById('profile-picture').src = data.profilePictureUrl;
                            document.getElementById('profile-picture').style.display = 'block';
                        } else {
                            document.getElementById('profile-picture').src = defaultProfilePic;
                            document.getElementById('profile-picture').style.display = 'block';
                        }
                        document.getElementById('user-email').innerText = data.emailPublic ? data.email : data.username;
                    }
                }, (err) => console.error("Profile listener error:", err));
            }
        }
    
        function startLeaderboardListener() {
            if (currentUser && currentUser.emailVerified) {
                if (leaderboardListener) leaderboardListener();
                document.getElementById('leaderboard-loading').style.display = 'block';
                leaderboardListener = db.collection("users").orderBy("clicks", "desc").limit(5).onSnapshot((snapshot) => {
                    document.getElementById('leaderboard-loading').style.display = 'none';
                    const leaderboard = document.getElementById('leaderboard');
                    leaderboard.innerHTML = '';
                    totalClicks = 0;
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.clicks !== undefined) {
                            const item = document.createElement('div');
                            item.className = 'leaderboard-item';
                            item.dataset.userId = doc.id;
                            if (doc.id === currentUser?.uid) {
                                item.id = 'user-leaderboard-item';
                            }
                            item.onclick = () => showUserProfile(doc.id);
                            const img = document.createElement('img');
                            img.src = userData.profilePictureUrl || defaultProfilePic;
                            img.alt = 'Profile';
                            const span = document.createElement('span');
                            span.textContent = `${userData.username} - ${userData.clicks} clicks`;
                            const incrementSpan = document.createElement('span');
                            incrementSpan.className = 'click-increment';
                            incrementSpan.textContent = '+1';
                            item.appendChild(img);
                            item.appendChild(span);
                            item.appendChild(incrementSpan);
                            leaderboard.appendChild(item);
                            totalClicks += userData.clicks;
                        }
                    });
                    updateChanceOfWinning();
                }, (err) => {
                    console.error("Error in leaderboard listener:", err);
                    document.getElementById('leaderboard-loading').style.display = 'none';
                });
            }
        }
    
        function showLeaderboardPopup() {
            if (!currentUser || !currentUser.emailVerified) {
                showErrorPopup("Please verify your email to view the leaderboard!");
                return;
            }
            const fullLeaderboard = document.getElementById('full-leaderboard');
            fullLeaderboard.innerHTML = '<div>Loading...</div>';
            db.collection("users").orderBy("clicks", "desc").get()
                .then((snapshot) => {
                    fullLeaderboard.innerHTML = '';
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.clicks !== undefined) {
                            const item = document.createElement('div');
                            item.className = 'leaderboard-item';
                            item.dataset.userId = doc.id;
                            item.onclick = () => showUserProfile(doc.id);
                            const img = document.createElement('img');
                            img.src = userData.profilePictureUrl || defaultProfilePic;
                            img.alt = 'Profile';
                            const span = document.createElement('span');
                            span.textContent = `${userData.username} - ${userData.clicks} clicks`;
                            item.appendChild(img);
                            item.appendChild(span);
                            fullLeaderboard.appendChild(item);
                        }
                    });
                    document.getElementById('leaderboard-popup').style.display = 'block';
                    document.getElementById('overlay').style.display = 'block';
                })
                .catch(err => {
                    console.error("Error fetching leaderboard:", err);
                    fullLeaderboard.innerHTML = 'Error loading leaderboard.';
                });
        }
    
        function hideLeaderboardPopup() {
            document.getElementById('leaderboard-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    
        function updateChanceOfWinning() {
            if (currentUser && currentUser.emailVerified) {
                const userRef = db.collection("users").doc(currentUser.uid);
                userRef.get().then((doc) => {
                    if (doc.exists) {
                        const userClicks = doc.data().clicks || 0;
                        const chance = totalClicks > 0 ? ((userClicks / totalClicks) * 100).toFixed(2) : 0;
                        document.getElementById('chance-of-winning').innerText = `Chance of Winning: ${chance}%`;
                    }
                }).catch(err => console.error("Error updating chance:", err));
            }
        }
    
        function showRulesPopup() {
            document.getElementById('rules-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
    
        function closeRulesPopup() {
            document.getElementById('rules-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    
        function showLogin() {
            document.getElementById('login-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
    
        function hideLogin() {
            document.getElementById('login-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    
        function showSignUp() {
            document.getElementById('signup-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
    
        function hideSignUp() {
            document.getElementById('signup-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    
        function showWelcomePopup(username) {
            document.getElementById('welcome-message').innerText = `Welcome, ${username}! ${currentUser && !currentUser.emailVerified ? "Verify your email to start clicking!" : "You could win 100% of the weekly ad revenue!"}`;
            document.getElementById('welcome-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
    
        function closeWelcomePopup() {
            document.getElementById('welcome-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    
        function showErrorPopup(message) {
            document.getElementById('error-message').innerText = message;
            document.getElementById('error-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
    
        function hideErrorPopup() {
            document.getElementById('error-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    
        function showUserProfile(userId) {
            if (!currentUser || !currentUser.emailVerified) {
                showErrorPopup("Please verify your email to view profiles!");
                return;
            }
            const userRef = db.collection("users").doc(userId);
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('popup-profile-picture').src = data.profilePictureUrl || defaultProfilePic;
                    document.getElementById('popup-user-email').innerText = `Username: ${data.username}${data.emailPublic ? `\nEmail: ${data.email}` : ''}`;
                    document.getElementById('popup-bio').innerText = data.bio || "No bio yet";
                    document.getElementById('popup-country').innerText = data.country || "Not specified";
                    document.getElementById('popup-join-date').innerText = `Joined: ${new Date(data.joinDate).toLocaleDateString()}`;
                    document.getElementById('popup-clicks').innerText = `Clicks: ${data.clicks || 0}`;
                    document.getElementById('popup-highest-cps').innerText = `Highest CPS: ${data.highestCPS || 0}`;
                    document.getElementById('user-profile-popup').style.display = 'block';
                    document.getElementById('overlay').style.display = 'block';
                }
            }).catch((error) => console.error("Error fetching user profile:", error));
        }
    
        function hideUserProfilePopup() {
            document.getElementById('user-profile-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    
        function showEditProfilePopup() {
            if (!currentUser || !currentUser.emailVerified) {
                showErrorPopup("Please verify your email to edit your profile!");
                return;
            }
            const userRef = db.collection("users").doc(currentUser.uid);
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('bio-input').value = data.bio || "";
                    document.getElementById('country-input').value = data.country || "";
                    document.getElementById('profile-picture-input').value = "";
                    document.getElementById('edit-profile-popup').style.display = 'block';
                    document.getElementById('overlay').style.display = 'block';
                }
            }).catch((error) => console.error("Error loading profile data:", error));
        }
    
        function hideEditProfilePopup() {
            document.getElementById('edit-profile-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    
        function login(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    hideLogin();
                    showWelcomePopup(userCredential.user.email.split('@')[0]);
                })
                .catch((error) => {
                    let friendlyMessage = "Login failed. Please try again.";
                    if (error.code === 'auth/user-not-found') {
                        friendlyMessage = "No account found with this email. Please sign up!";
                    } else if (error.code === 'auth/wrong-password' || error.message.includes("INVALID_LOGIN_CREDENTIALS")) {
                        friendlyMessage = "Incorrect password. Please check and try again.";
                    }
                    showErrorPopup(friendlyMessage);
                });
        }
    
        function signUp(event) {
            event.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const emailPublic = document.getElementById('privacy-toggle').checked;
    
            if (username.length === 0) {
                showErrorPopup("Please enter a username!");
                return;
            }
    
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    currentUser.sendEmailVerification().then(() => {
                        const userRef = db.collection("users").doc(currentUser.uid);
                        userRef.set({
                            username: username,
                            email: currentUser.email,
                            emailPublic: emailPublic,
                            clicks: 0,
                            joinDate: new Date().toISOString(),
                            playtime: 0,
                            bio: "",
                            profilePictureUrl: "",
                            country: "",
                            highestCPS: 0,
                            emailVerified: false
                        }).then(() => {
                            hideSignUp();
                            showWelcomePopup(username);
                        }).catch(err => console.error("Error setting user data:", err));
                    });
                })
                .catch((error) => {
                    let friendlyMessage = "Sign-up failed. Please try again.";
                    if (error.code === 'auth/email-already-in-use') {
                        friendlyMessage = "This email is already in use. Try logging in!";
                    } else if (error.code === 'auth/weak-password') {
                        friendlyMessage = "Password too weak. Use at least 6 characters.";
                    }
                    showErrorPopup(friendlyMessage);
                });
        }
    
        function logout() {
            if (leaderboardListener) leaderboardListener();
            if (profileListener) profileListener();
            auth.signOut().then(() => {
                currentUser = null;
                localClicks = 0;
                clickBuffer = 0;
                document.getElementById('click-count').innerText = 'Clicks: 0';
                document.getElementById('user-email').innerText = 'Not Logged In';
                document.getElementById('bio').innerText = 'No bio yet';
                document.getElementById('country').innerText = 'Not specified';
                document.getElementById('join-date').innerText = '';
                document.getElementById('profile-picture').style.display = 'none';
                document.getElementById('chance-of-winning').innerText = 'Chance of Winning: 0%';
                document.getElementById('highest-cps').innerText = 'Highest CPS: 0';
                document.getElementById('login-btn').style.display = 'inline-block';
                document.getElementById('signup-btn').style.display = 'inline-block';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('edit-profile-btn').style.display = 'none';
                document.getElementById('delete-account-btn').style.display = 'none';
                document.getElementById('click-message').style.display = 'block';
                document.getElementById('click-btn').disabled = true;
                document.getElementById('leaderboard').innerHTML = '';
            }).catch((error) => console.error("Logout failed:", error));
        }
    
        function loadUserData() {
            if (currentUser && currentUser.emailVerified) {
                const userRef = db.collection("users").doc(currentUser.uid);
                userRef.get().then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        localClicks = data.clicks || 0;
                        document.getElementById('click-count').innerText = `Clicks: ${localClicks}`;
                        document.getElementById('join-date').innerText = `Joined: ${new Date(data.joinDate).toLocaleDateString()}`;
                        document.getElementById('bio').innerText = data.bio || "No bio yet";
                        document.getElementById('country').innerText = data.country || "Not specified";
                        document.getElementById('highest-cps').innerText = `Highest CPS: ${data.highestCPS || 0}`;
                        if (data.profilePictureUrl) {
                            document.getElementById('profile-picture').src = data.profilePictureUrl;
                            document.getElementById('profile-picture').style.display = 'block';
                        } else {
                            document.getElementById('profile-picture').src = defaultProfilePic;
                            document.getElementById('profile-picture').style.display = 'block';
                        }
                        document.getElementById('edit-profile-btn').style.display = 'block';
                        document.getElementById('delete-account-btn').style.display = 'block';
                        document.getElementById('user-email').innerText = data.emailPublic ? data.email : data.username;
                        document.getElementById('click-message').style.display = 'none';
                    }
                }).catch((error) => console.error("Error loading user data:", error));
            }
        }
    
        function saveProfile(event) {
            event.preventDefault();
            if (!currentUser || !currentUser.emailVerified) {
                showErrorPopup("Please verify your email to save your profile!");
                return;
            }
            const bio = document.getElementById('bio-input').value;
            const country = document.getElementById('country-input').value;
            const file = document.getElementById('profile-picture-input').files[0];
            const userRef = db.collection("users").doc(currentUser.uid);
    
            if (file) {
                if (file.size > 32 * 1024 * 1024) {
                    showErrorPopup("Image must be under 32 MB!");
                    return;
                }
                const formData = new FormData();
                formData.append("image", file);
                fetch("https://api.imgbb.com/1/upload?key=6055d35ebda650b6bc19fbdffc564e0d", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const url = data.data.url;
                        return userRef.update({ bio, country, profilePictureUrl: url })
                            .then(() => {
                                loadUserData();
                                hideEditProfilePopup();
                            });
                    } else {
                        showErrorPopup("Image upload failed: " + (data.error?.message || "Unknown error"));
                    }
                })
                .catch(err => {
                    console.error("ImgBB/Firestore error:", err);
                    showErrorPopup("Profile update failed!");
                });
            } else {
                userRef.update({ bio, country })
                    .then(() => {
                        loadUserData();
                        hideEditProfilePopup();
                    })
                    .catch(err => console.error("Firestore update error:", err));
            }
        }
    
        function calculateCPS() {
            const now = Date.now();
            clickTimestamps = clickTimestamps.filter(ts => now - ts < 1000);
            const cps = clickTimestamps.length;
            if (cps > 40) {
                showErrorPopup("Autoclicker detected! Please stop using autoclickers.");
                fakeCPSCount += cps;
                if (fakeCPSCount > 300) {
                    deleteAccount(true);
                }
            }
            if (cps > highestCPS) {
                highestCPS = cps;
                if (currentUser && currentUser.emailVerified) {
                    db.collection("users").doc(currentUser.uid).update({ highestCPS: cps });
                }
            }
            return cps;
        }
    
        function incrementClicks(event) {
            if (!currentUser) {
                document.getElementById('click-message').style.display = 'block';
                return;
            }
            if (!currentUser.emailVerified) {
                showErrorPopup("Please verify your email to start clicking!");
                return;
            }
    
            localClicks += 1;
            clickBuffer += 1;
            clickTimestamps.push(Date.now());
            calculateCPS();
            document.getElementById('click-count').innerText = `Clicks: ${localClicks}`;
    
            const rect = document.getElementById('click-btn').getBoundingClientRect();
            const x = event.clientX;
            const y = event.clientY;
            createParticles(x, y);
    
            if (!clickSpeedBoost) {
                clickSpeedBoost = true;
                updateStarSpeed(true);
                setTimeout(() => {
                    clickSpeedBoost = false;
                    updateStarSpeed(false);
                }, 500);
            }
    
            if (syncTimeout) clearTimeout(syncTimeout);
            syncTimeout = setTimeout(syncClicks, 500);
    
            if (currentUser) {
                const userItem = document.querySelector(`.leaderboard-item[data-user-id="${currentUser.uid}"]`);
                if (userItem) {
                    const incrementSpan = userItem.querySelector('.click-increment');
                    incrementSpan.classList.add('show');
                    setTimeout(() => incrementSpan.classList.remove('show'), 500);
                }
            }
        }
    
        function syncClicks() {
            if (clickBuffer > 0 && currentUser && currentUser.emailVerified) {
                const userRef = db.collection("users").doc(currentUser.uid);
                userRef.update({
                    clicks: firebase.firestore.FieldValue.increment(clickBuffer)
                }).then(() => {
                    clickBuffer = 0;
                }).catch(err => console.error("Error syncing clicks:", err));
            }
        }
    
        function deleteAccount(force = false) {
            if (!currentUser) return;
            if (!force && !confirm("Are you sure you want to delete your account? This action cannot be undone.")) return;
            const userRef = db.collection("users").doc(currentUser.uid);
            userRef.delete().then(() => {
                auth.currentUser.delete().then(() => {
                    logout();
                });
            }).catch(err => console.error("Error deleting account:", err));
        }
    
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                if (currentUser.emailVerified) {
                    loadUserData();
                    startProfileListener();
                    startLeaderboardListener();
                    document.getElementById('login-btn').style.display = 'none';
                    document.getElementById('signup-btn').style.display = 'none';
                    document.getElementById('logout-btn').style.display = 'inline-block';
                    document.getElementById('click-btn').disabled = false;
                    document.getElementById('click-message').style.display = 'none';
                    document.getElementById('edit-profile-btn').style.display = 'block';
                    document.getElementById('delete-account-btn').style.display = 'block';
                } else {
                    document.getElementById('click-btn').disabled = true;
                    document.getElementById('click-message').innerText = "Please verify your email to start clicking!";
                    document.getElementById('click-message').style.display = 'block';
                    document.getElementById('login-btn').style.display = 'none';
                    document.getElementById('signup-btn').style.display = 'none';
                    document.getElementById('logout-btn').style.display = 'inline-block';
                    document.getElementById('edit-profile-btn').style.display = 'none';
                    document.getElementById('delete-account-btn').style.display = 'block';
                }
            } else {
                if (leaderboardListener) leaderboardListener();
                if (profileListener) profileListener();
                currentUser = null;
                localClicks = 0;
                clickBuffer = 0;
                document.getElementById('click-count').innerText = 'Clicks: 0';
                document.getElementById('user-email').innerText = 'Not Logged In';
                document.getElementById('bio').innerText = 'No bio yet';
                document.getElementById('country').innerText = 'Not specified';
                document.getElementById('join-date').innerText = '';
                document.getElementById('profile-picture').style.display = 'none';
                document.getElementById('chance-of-winning').innerText = 'Chance of Winning: 0%';
                document.getElementById('highest-cps').innerText = 'Highest CPS: 0';
                document.getElementById('login-btn').style.display = 'inline-block';
                document.getElementById('signup-btn').style.display = 'inline-block';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('edit-profile-btn').style.display = 'none';
                document.getElementById('delete-account-btn').style.display = 'none';
                document.getElementById('click-btn').disabled = true;
                document.getElementById('click-message').style.display = 'block';
                document.getElementById('leaderboard').innerHTML = '';
            }
        });
    
        initSpaceBackground();
    </script>
</body>
</html>